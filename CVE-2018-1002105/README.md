# 漏洞分析

## 一、漏洞基本信息

| Item           | Details                                          | Note              |
| -------------- | ------------------------------------------------ | ----------------- |
| Project        | Kubernetes                                       |                   |
| Publish Date   | 2018-11-08                                       |                   |
| Confirm        | https://github.com/kubernetes/kubernetes/issues/71411 |              |
| CVE-ID         | CVE-2018-1002105                                 | mitre, cvedetails |
| Exploits       | disclose                                         | see in image      |
| Affect Version | < 1.10.11, 1.11.0-1.11.4, 1.12.0-1.12.2          |                   |
| Fix Version    | 1.10.11, 1.11.5, 1.12.3                          |                   |
| Fix Commit     | https://github.com/kubernetes/kubernetes/pull/71412/commits  |       |
| CVSS           | 9.8 CVSS:3.0/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H |                   |
| Vuln’s Author  | Darren Shepherd                                  |                   |


## 二、组件简介
Kubernetes API 服务器验证并配置 API 对象的数据， 这些对象包括 pods、services、replicationcontrollers 等。 API 服务器为 REST 操作提供服务，并为集群的共享状态提供前端， 所有其他组件都通过该前端进行交互

## 三、漏洞详情

### 1. 介绍
当用户具备名字空间A中的pods/exec权限时，可构造错误的pods/exec请求给kube-apiserver，它会把请求转发给kubelet，但由于没有判断返回值，导致kube-apiserver和kubelet的连接依旧存在。攻击者通过复用该连接，可在该kubelet掌管的所有pod中执行任意命令

### 2. 影响
- 当攻击者具备访问聚合层API服务的某个API的权限时，可以提权到访问该API服务的所有API
- 当攻击者具备某个命名空间下的某个pod的exec/attach/portforward的API调用权限时，可提权到在任意命名空间下的任意pod中执行

## 四、防御
- 为非可信用户移除exec/attach/portforward权限
- 禁止非可信用户访问聚合层API服务

## 五、漏洞复现
### 1. 复现环境
```
docker pull noirfate/vul-k8s-cve-2018-1002105:1.0
```
### 2. 复现过程
```
docker-compose up
ssh -p12222 root@127.0.0.1
cd exploit
./run
```

## 六、漏洞分析
- [分析文章](https://paper.seebug.org/757/#)

## 七、漏洞修复分析

## 八、漏洞挖掘方法与过程

## 九、同类问题挖掘方法

### 设计实现层

### Fuzz

### codeql

## 十、时间线

