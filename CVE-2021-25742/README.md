# 漏洞分析

## 一、漏洞基本信息

| Item           | Details                                          | Note              |
| -------------- | ------------------------------------------------ | ----------------- |
| Project        | Kubernetes                                       |                   |
| Publish Date   | 2021-10-29                                       |                   |
| Confirm        | https://github.com/kubernetes/ingress-nginx/issues/7837 |            |
| CVE-ID         | CVE-2021-25742                                   | mitre, cvedetails |
| Exploits       | disclose                                         | see in image      |
| Affect Version | <= 0.49.0, 1.0.0                                 |                   |
| Fix Version    | 0.49.1, 1.0.1                                    |                   |
| Fix Commit     | no fix, only mitigation                          |                   |
| CVSS           | 7.6 CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:H/I:L/A:L |                   |
| Vuln’s Author  | Mitch Hulscher                                   |                   |


## 二、组件简介
ingress-nginx是Kubernetes的一个Ingress控制器，它使用Nginx作为反向代理和负载均衡

## 三、漏洞详情

### 1. 介绍
当用户具有更新Ingress对象的权限时，可以使用自定义代码片段的功能来获取ingress-nginx的`serviceaccout token`，再通过该凭证获取集群内所有的secrets

### 2. 影响
具有更新Ingress对象权限的用户可通过此漏洞提权到集群管理员

## 四、防御
0.49版本及以下与1.0.0版本无可用缓解措施，0.49.1和1.0.1及以上版本可以通过禁止snippet注释来规避此漏洞

## 五、漏洞复现
### 1. 复现环境
```
docker pull noirfate/vul-k8s-cve-2021-25742:1.0
```
### 2. 复现过程
```
docker-compose up
ssh -p12222 root@127.0.0.1
cd exploit
./run
```

## 六、漏洞分析
在安装ingress-nginx之后，可以使用`nginx.ingress.kubernetes.io/server-snippet`注释添加lua脚本执行任意代码，例如读取本地`serviceaccout token`

## 七、漏洞修复分析
此漏洞未进行修复，只是增加了缓解措施，如集群未实施缓解措施，则仍可利用

## 八、漏洞挖掘方法与过程

## 九、同类问题挖掘方法

### 设计实现层
- 通过kubernetes插件的漏洞控制集群
- 通过部分权限获取集群管理员权限

### Fuzz

### codeql

## 十、时间线

