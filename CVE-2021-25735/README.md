# 漏洞分析

## 一、漏洞基本信息

| Item           | Details                                          | Note              |
| -------------- | ------------------------------------------------ | ----------------- |
| Project        | Kubernetes                                       |                   |
| Publish Date   | 2021-04-28                                     |  |
| Confirm        | https://github.com/kubernetes/kubernetes/issues/100096 |             |
| CVE-ID         | CVE-2021-25735     | NVD  |
| Exploits       | disclose                                         |       |
| Affect Version | kube-apiserver v1.20.0 to v1.20.5 kube-apiserver v1.19.0 to v1.19.9 kube-apiserver <= v1.18.17 |             |
| Fix Version    | kube-apiserver v1.21.0 - kube-apiserver v1.20.6 kube-apiserver v1.19.10 kube-apiserver v1.18.18 |                   |
| Fix Commit     | https://github.com/kubernetes/kubernetes/pull/99946/commits |      |
| CVSS           | 6.5 CVSS:3.1/AV:N/AC:L/PR:H/UI:N/S:U/C:N/I:H/A:H |                   |
| Vuln’s Author  | Rogerio Bastos & Ari Lima from RedHat |                   |

## 二、组件简介

kube-apiserver，也就是Kubernetes API 服务，安装在控制面，负责验证并配置pods、services、replicationcontrollers 等对象，所有组件也都通过该apiserver进行交互。

webhook可以理解为用户自己实现的检查服务，设置为Validation Admission Webhook后，每个发送给apiserver的请求都会交给webhook进行检查。

## 三、漏洞详情

### 1. 介绍

漏洞出现在kube-apiserver，apiserver会传递旧的节点配置（request.oldObject）和新的节点配置（request.object）给Admission Webhook，但apiserver会用新配置覆盖旧配置中的部分对象，导致旧节点的ObjectMeta会被新节点的数据覆盖。如果Validating Admission Webhook使用旧节点ObjectMeta中的数据作为判断依据的话，就会出现此漏洞，攻击者可以通过修改ObjectMeta来绕过检查。

### 2. 影响

攻击者可利用此漏洞绕过使用ObjectMeta作为判断依据的Validating Admission Webhook的检查。

## 四、防御

## 五、漏洞复现

漏洞的复现和利用需要结合Webhook的检查逻辑实现，这里构造了一个可被此漏洞利用的Webhook服务，该服务会使用节点tag字段中的`changeAllowed: "false"`来作为是否有权限对node进行修改的依据。攻击者可以在对node进行修改时设置`changeAllowed: "true"`来绕过检查。

### 1. 复现环境

```
docker pull noirfate/vul-k8s-cve-2021-25735:1.0
```

### 2. 复现过程


```
docker-compose up
ssh -p12222 root@127.0.0.1
cd exploit
./run
```

## 六、漏洞分析

webhook收到api-server提供的request.object和request.oldObject，分别包含新配置和旧配置。但是漏洞版本的api-server代码中，一部分oldNode.spec被Node.spec替换，包括ObjectMeta也被覆盖。于是，基于旧配置的部分检查可以被绕过。

例如复现中基于旧label changeAllowed是否为true进行判断的webhook，只需要在新配置中添加chageAllowed是true即可被允许通过检查。

下面是漏洞修复中pkg/apis/core/validation/validation.go被删除的部分代码

```
oldNode.Status.Config = node.Status.Config


// TODO: move reset function to its own location

// Ignore metadata changes now that they have been tested

oldNode.ObjectMeta = node.ObjectMeta

// Allow users to update capacity

oldNode.Status.Capacity = node.Status.Capacity

// Allow users to unschedule node

oldNode.Spec.Unschedulable = node.Spec.Unschedulable

// Clear status

oldNode.Status = node.Status
```

参考：<br>
https://sysdig.com/blog/cve-2021-25735-kubernetes-admission-bypass/<br>
https://github.com/darryk10/CVE-2021-25735

## 七、漏洞修复分析

k8s修改代码逻辑，去除了新值对旧值的覆盖。

## 八、漏洞挖掘方法与过程

## 九、同类问题挖掘方法

### 设计实现层

检查apiserver传递给webhook的参数中是否存在新值对旧值的覆盖

### Fuzz

### codeql

## 十、时间线

