# 漏洞分析

## 一、漏洞基本信息

| Item           | Details                                          | Note              |
| -------------- | ------------------------------------------------ | ----------------- |
| Project        | Kubernetes                                       |                   |
| Publish Date   | 2018-03-13                                       |                   |
| Confirm        | https://github.com/kubernetes/kubernetes/issues/60813 |              |
| CVE-ID         | CVE-2017-1002101                                 | mitre, cvedetails |
| Exploits       | disclose                                         | see in image      |
| Affect Version | 1.3.x-1.6.x, 1.7.0-1.7.13, 1.8.0-1.8.8, 1.9.0-1.9.3 |                |
| Fix Version    | 1.7.14, 1.8.9, 1.9.4                             |                   |
| Fix Commit     | https://github.com/kubernetes/kubernetes/pull/61044/commits  |       |
| CVSS           | 8.8 CVSS:3.0/AV:N/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H |                   |
| Vuln’s Author  |                                                  |                   |


## 二、组件简介
kubelet是在每个Node节点上运行的主要 “节点代理”，接受通过各种机制（主要是通过apiserver）提供的一组PodSpec，并确保这些PodSpec中描述的容器处于运行状态且运行状况良好

## 三、漏洞详情

### 1. 介绍
创建pod时，设置容器A和容器B都挂载相同的hostPath，容器A先启动并在hostPath下创建指向/的符号链接rootLink，设置容器B的hostPath的subPath为rootLink，当启动容器B后，kubelet会把宿主机/挂载到容器B中

### 2. 影响
拥有创建pod权限的用户可利用恶意的pod配置和容器镜像实现挂载宿主机的任意目录，进而完成容器逃逸，控制宿主机

## 四、防御
禁止不可信的用户创建pod类的资源(deployments、replicasets等等)，或者在PodSecurityPolicy中禁用所有volume类型(这会导致无法使用service account token，并且需要设置automountServiceAccountToken: false)

## 五、漏洞复现
### 1. 复现环境
```
docker pull noirfate/vul-k8s-cve-2017-1002101:1.0
```
### 2. 复现过程
```
docker-compose up
ssh -p12222 root@127.0.0.1
cd exploit
./run
```

## 六、漏洞分析
- [分析文章](https://github.com/Metarget/cloud-native-security-book/blob/main/appendix/CVE-2017-1002101%EF%BC%9A%E7%AA%81%E7%A0%B4%E9%9A%94%E7%A6%BB%E8%AE%BF%E9%97%AE%E5%AE%BF%E4%B8%BB%E6%9C%BA%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F.pdf)

## 七、漏洞修复分析
对该漏洞的修复并不完全，虽然在执行mount前确保了subpath不会指向宿主机，但mount系统调用仍会解析符号链接，导致存在条件竞争漏洞，可在检查之后、mount之前修改符号链接，详见[逃逸风云再起：从CVE-2017-1002101到CVE-2021-25741](https://mp.weixin.qq.com/s/RqaWvzXZR6sLPzBI8ljoxg)

## 八、漏洞挖掘方法与过程

## 九、同类问题挖掘方法

### 设计实现层		
kubelet负责在节点上创建pod、挂载目录，可检查其涉及路径处理的代码中是否存在符号链接解析、TOCTOU的问题

### Fuzz	

### codeql	

## 十、时间线

