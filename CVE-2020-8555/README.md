# 漏洞分析

## 一、漏洞基本信息

| Item           | Details                                          | Note              |
| -------------- | ------------------------------------------------ | ----------------- |
| Project        | Kubernetes                                       |                   |
| Publish Date   | 2020-04-07                                       |                   |
| Confirm        | https://github.com/kubernetes/kubernetes/issues/91542  |             |
| CVE-ID         | CVE-2020-8555                                    | mitre, cvedetails |
| Exploits       | disclose                                         | see in image      |
| Affect Version | <= 1.15.11, 1.16.0-1.16.8, 1.17.0-1.17.4, 1.18.0 |                   |
| Fix Version    | 1.15.12, 1.16.9, 1.17.5, 1.18.1                  |                   |
| Fix Commit     | https://github.com/kubernetes/kubernetes/pull/89837/commits   |      |
| CVSS           | 6.3 CVSS:3.1/AV:N/AC:H/PR:L/UI:N/S:C/C:H/I:N/A:N |                   |
| Vuln’s Author  | Brice Augras from Groupe-Asten and Christophe Hauquiert from Nokia   |  |


## 二、组件简介
Kubernetes控制器管理器是一个守护进程，内置了核心控制回路。在Kubernetes中，每个控制器是一个控制回路，通过API服务器监视集群的共享状态，并尝试进行更改以将当前状态转为期望状态。目前，Kubernetes自带的控制器例子包括副本控制器、节点控制器、命名空间控制器和服务账号控制器等

## 三、漏洞详情

### 1. 介绍
kube-controller-manager存在SSRF漏洞，攻击者在创建`StorageClass`时，通过指定`resturl`诱导kube-controller-manager去访问攻击者指定的url，并可在日志中查看最多500字节的返回内容

### 2. 影响
当攻击者拥有创建`StorageClass`权限或创建使用如下`(GlusterFS, Quobyte, StorageOS, ScaleIO)`卷的`pod`的权限时，可让`kube-controller-manager`发送`GET`或`POST`请求（无法控制请求体）到master主机网络

## 四、防御
禁止给非可信用户创建`pod`和创建`StorageClass`的权限

## 五、漏洞复现
### 1. 复现环境
```
docker pull noirfate/vul-k8s-cve-2020-8555:1.0
```
### 2. 复现过程
```
docker-compose up
ssh -p12222 root@127.0.0.1
cd exploit
./run
```

## 六、漏洞分析
- [分析文章](https://medium.com/@BreizhZeroDayHunters/when-its-not-only-about-a-kubernetes-cve-8f6b448eafa8)

## 七、漏洞修复分析
禁止打印详细日志

## 八、漏洞挖掘方法与过程

## 九、同类问题挖掘方法

### 设计实现层
- 源码中日志打印是否会泄露敏感信息
- 资源配置中是否存在`url`类参数

### Fuzz

### codeql

## 十、时间线

