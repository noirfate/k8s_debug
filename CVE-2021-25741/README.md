# 漏洞分析

## 一、漏洞基本信息

| Item           | Details                                          | Note              |
| -------------- | ------------------------------------------------ | ----------------- |
| Project        | Kubernetes                                       |                   |
| Publish Date   | 2021-09-16                                       |                   |
| Confirm        | https://github.com/kubernetes/kubernetes/issues/104980 |             |
| CVE-ID         | CVE-2021-25741                                   | mitre, cvedetails |
| Exploits       | disclose                                         | see in image      |
| Affect Version | < 1.9.14, 1.22.0-1.22.1, 1.21.0-1.21.4, 1.20.0-1.20.10 |             |
| Fix Version    | 1.22.2, 1.21.5, 1.20.11, 1.19.15                 |                   |
| Fix Commit     | https://github.com/kubernetes/kubernetes/pull/104253/commits  |      |
| CVSS           | 8.8 CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H |                   |
| Vuln’s Author  | Fabricio Voznika and Mark Wolters of Google      |                   |


## 二、组件简介
kubelet是在每个Node节点上运行的主要 “节点代理”，接受通过各种机制（主要是通过apiserver）提供的一组PodSpec，并确保这些PodSpec中描述的容器处于运行状态且运行状况良好

## 三、漏洞详情

### 1. 介绍
CVE-2017-1002101的修复策略不完善，如下图所示，在校验完成后会调用mount，而mount会跟随符号链接，这会产生TOCTOU漏洞。通过renameat2(AT\_FDCWD, source, AT\_FDCWD, dest, RENAME\_EXCHANGE)系统调用在校验后mount前修改路径为符号链接

### 2. 影响
拥有创建pod权限的用户可利用恶意的pod配置和容器镜像实现挂载宿主机的任意目录，进而完成容器逃逸，控制宿主机

## 四、防御
禁止不可信的用户创建pod类的资源(deployments、replicasets等等)，或者在PodSecurityPolicy中禁用所有volume类型(这会导致无法使用service account token，并且需要设置automountServiceAccountToken: false)

## 五、漏洞复现
### 1. 复现环境
```
docker pull noirfate/vul-k8s-cve-2021-25741:1.0
```
### 2. 复现过程
```
docker-compose up
ssh -p12222 root@127.0.0.1
cd exploit
./run
```

## 六、漏洞分析
- [分析文章](https://mp.weixin.qq.com/s/RqaWvzXZR6sLPzBI8ljoxg)

## 七、漏洞修复分析
在调用mount时传递了--no-canonicalize参数

## 八、漏洞挖掘方法与过程

## 九、同类问题挖掘方法

### 设计实现层
kubelet负责在节点上创建pod、挂载目录，可检查其涉及路径处理的代码中是否存在符号链接解析、TOCTOU的问题

### Fuzz

### codeql

## 十、时间线

